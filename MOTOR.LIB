LIBRARY LOAD "74HC595.LIB"

MOTOR1_A = 2
MOTOR1_B = 3
MOTOR2_A = 1
MOTOR2_B = 4
MOTOR4_A = 0
MOTOR4_B = 6
MOTOR3_A = 5
MOTOR3_B = 7

FORWARD = 1
BACKWARD = 2
BRAKE = 3
RELEASE = 4

SINGLE = 1
DOUBLE = 2
INTERLEAVE = 3
MICROSTEP = 4

MOTOR.LATCH = D12
MOTOR.CLK = D4
MOTOR.ENABLE = D7
MOTOR.DATA = D8
JUNK = D13
PWM0A = D6
PWM0B = D5
PWM1A = D9
PWM1B = D10
PWM2A = D11
PWM2B = D3
SPEED = 0

SUB CONTROLLER.ENABLE
    SETPIN MOTOR.LATCH, DOUT
    SETPIN MOTOR.CLK,DOUT
    SETPIN MOTOR.ENABLE,DOUT
    SETPIN MOTOR.DATA,DOUT
    SETPIN EMPTY,DIN
    LATCH_STATE = 0

    PIN(MOTOR.ENABLE) = 0
END SUB

SUB INITPWM(MOTORNUM)
    IF MOTORNUM = 1 THEN
        SETPIN PWM2A,DOUT
        PIN(PWM2A) = 0
    ELSEIF MOTORNUM = 2 THEN
        SETPIN PWM2B,DOUT
        PIN(PWM2B) = 0
    ELSEIF MOTORNUM = 3 THEN
        SETPIN PWM0A,DOUT
        PIN(PWM0A) = 0
    ELSEIF MOTORNUM = 4 THEN
        SETPIN PWM0B,DOUT
        PIN(PWM0B) = 0
    ENDIF
END SUB

SUB SETSPEED(MOTORNUM,DUTY)
    SPEED = 0.004*DUTY
    IF MOTORNUM = 1 THEN
        SETTICK 1,PWM2A:,1
    ELSEIF MOTORNUM = 2 THEN
        SETTICK 1,PWM2B:,2
    ELSEIF MOTORNUM = 3 THEN
        SETTICK 1,PWM0A:,3
    ELSEIF MOTORNUM = 4 THEN
        SETTICK 1,PWM0B:,4
    ENDIF
    GOTO SKIP:    
PWM2A:  PULSE PWM2A,(SPEED)
        IRETURN
PWM2B:  PULSE PWM2B,(SPEED)
        IRETURN
PWM0A:  PULSE PWM0A,(SPEED)
        IRETURN
PWM0B:  PULSE PWM0B,(SPEED)
        IRETURN
SKIP:
END SUB

SUB DCMOTOR.ENABLE(MOTORNUM)
    IF MOTORNUM = 1 THEN
