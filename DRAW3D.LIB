SUB READFILE
    CLEAR
    Input "ENTER .OBJ FILE: ",FILENAME$
    INLINE$ = ""
    COUNTPOINTSLINES(FILENAME$)
    Open FILENAME$ For INPUT As #3
    POINTCNT = 0
    LINECNT = 0
    DO WHILE EOF(#3) = 0
        LINE INPUT #3,INLINE$
        IF WORD$(INLINE$,1) = "v" THEN
            READPOINTS(INLINE$,POINTCNT)
            POINTCNT = POINTCNT + 1
        ELSEIF WORD$(INLINE$,1) = "f" OR WORD$(INLINE$,1) = "l" THEN
            READLINES(INLINE$,LINECNT)
            LINECNT = LINECNT + 1
        ENDIF
    LOOP 
    CLOSE #3
    NORMALISE
END SUB

SUB COUNTPOINTSLINES(FILENAME2$)
    POINTS = 0
    LINES = 0
    MEMMAX = 1024
    Open FILENAME2$ For INPUT As #3
    DO WHILE EOF(#3) = 0
        Line Input #3,INLINE$
        IF WORD$(INLINE$,1) = "v" THEN
            POINTS = POINTS + 1
        ELSEIF WORD$(INLINE$,1) = "f" OR WORD$(INLINE$,1) = "l" THEN
            LINES = LINES + 1
        ENDIF
    LOOP
    CLOSE #3
    IF POINTS > MEMMAX THEN
        POINTS = MEMMAX
    ENDIF
    IF LINES > MEMMAX THEN
        LINES = MEMMAX
    ENDIF
    DIM POINTS(POINTS,3)
    DIM LINES(LINES,3)
END SUB

SUB READPOINTS(INLINE2$,POINT2)
    i = 2
    FOR j = 0 TO 2
        POINTS(POINT2,j) = VAL(WORD$(INLINE2$,i))
        i = i + LEN(WORD$(INLINE2$,i))
    NEXT
END SUB

SUB READLINES(INLINE2$,LINE2)
    i = 2
    FOR j = 0 TO 2
        LINES(LINE2,j) = VAL(WORD$(INLINE2$,i))
        i = i + LEN(WORD$(INLINE2$,i))
    NEXT
END SUB

FUNCTION WORD$(INLINE3$,START,NOSPC)
    IF START < 1 THEN
        START = 1
    ENDIF
    LOCAL k = 0
    WORD$ = ""
    DO WHILE MID$(INLINE3$,START+k,1) = " "
        k = k + 1
        IF NOSPC <> 0 THEN
            START = START + 1
        ENDIF
    LOOP
    DO WHILE MID$(INLINE3$,START+k,1) <> " " AND (START+k) =< LEN(INLINE3$)
        k = k + 1
    LOOP 
    IF k > 0 THEN
        WORD$ = MID$(INLINE3$,START,k)
    ENDIF
END FUNCTION

Sub ROTATE(DIR$,INCRE)
    IF INCRE = 0 THEN
        INCRE = 15
    ENDIF
    For i = 0 To POINTS - 1
        If DIR$ = "ZMINUS" Then
            x = (POINTS(i, 0) * Cos(Rad(INCRE))) - (POINTS(i, 1) * Sin(Rad(INCRE)))
            y = (POINTS(i, 0) * Sin(Rad(INCRE))) + (POINTS(i, 1) * Cos(Rad(INCRE)))
            POINTS(i, 0) = x
            POINTS(i, 1) = y
        ElseIf DIR$ = "ZPLUS" Then
            x = (POINTS(i, 0) * Cos(Rad(-INCRE))) - (POINTS(i, 1) * Sin(Rad(-INCRE)))
            y = (POINTS(i, 0) * Sin(Rad(-INCRE))) + (POINTS(i, 1) * Cos(Rad(-INCRE)))
            POINTS(i, 0) = x
            POINTS(i, 1) = y
        ElseIf DIR$ = "XMINUS" Then
            y = (POINTS(i, 1) * Cos(Rad(INCRE))) - (POINTS(i, 2) * Sin(Rad(INCRE)))
            z = (POINTS(i, 1) * Sin(Rad(INCRE))) + (POINTS(i, 2) * Cos(Rad(INCRE)))
            POINTS(i, 1) = y
            POINTS(i, 2) = z
        ElseIf DIR$ = "XPLUS" Then
            y = (POINTS(i, 1) * Cos(Rad(-INCRE))) - (POINTS(i, 2) * Sin(Rad(-INCRE)))
            z = (POINTS(i, 1) * Sin(Rad(-INCRE))) + (POINTS(i, 2) * Cos(Rad(-INCRE)))
            POINTS(i, 1) = y
            POINTS(i, 2) = z
        ElseIf DIR$ = "YMINUS" Then
            x = (POINTS(i, 0) * Cos(Rad(INCRE))) - (POINTS(i, 2) * Sin(Rad(INCRE)))
            z = (POINTS(i, 0) * Sin(Rad(INCRE))) + (POINTS(i, 2) * Cos(Rad(INCRE)))
            POINTS(i, 0) = x
            POINTS(i, 2) = z
        ElseIf DIR$ = "YPLUS" Then
            x = (POINTS(i, 0) * Cos(Rad(-INCRE))) - (POINTS(i, 2) * Sin(Rad(-INCRE)))
            z = (POINTS(i, 0) * Sin(Rad(-INCRE))) + (POINTS(i, 2) * Cos(Rad(-INCRE)))
            POINTS(i, 0) = x
            POINTS(i, 2) = z
        EndIf
    Next
End Sub

SUB NORMALISE
    HIGHEST = 0
    FOR i = 0 TO POINTS - 1
        FOR j = 0 TO 2
            IF ABS(POINTS(i,j)) > HIGHEST THEN
                HIGHEST = POINTS(i,j)
            ENDIF
        NEXT
    NEXT
    FOR i = 0 TO POINTS - 1
        FOR j = 0 TO 2
            POINTS(i,j) = POINTS(i,j) / HIGHEST
        NEXT
    NEXT
END SUB

SUB DRAWLINE(MAGX,XOFFSET,YOFFSET,ZOFFSET)
    LOCAL CURRENT(6)
    CENTRE.X = MM.HRES/2
    CENTRE.Y = MM.VRES/2
    IF MAGX = 0 THEN
        MAGX = 150
    ENDIF
    FOR j = 0 TO LINES-1
        FOR i = 0 TO 2
            CURRENT(i) = POINTS(LINES(j,0),i) * MAGX
            CURRENT(i+3) = POINTS(LINES(j,1),i) * MAGX
        NEXT
        FOR i = 0 TO 1
            CURRENT(i) = FOV(CURRENT(i)+XOFFSET,CURRENT(2)+ZOFFSET)
            CURRENT(i+3) = FOV(CURRENT(i)+YOFFSET,CURRENT(2)+ZOFFSET)
        NEXT
        x1 = CENTRE.X+CURRENT(0)
        y1 = CENTRE.Y+CURRENT(1)
        x2 = CENTRE.X+CURRENT(3)
        y2 = CENTRE.Y+CURRENT(4)
        LINE(x1,y1)-(x2,y2)
        IF LINES(j,2) > 0 THEN
            FOR i = 0 TO 2
                CURRENT(i) = POINTS(LINES(j,1),i) * MAGX
                CURRENT(i+3) = POINTS(LINES(j,2),i) * MAGX
            NEXT
            FOR i = 0 TO 1
                CURRENT(i) = FOV(CURRENT(i)+XOFFSET,CURRENT(2)+ZOFFSET)
                CURRENT(i+3) = FOV(CURRENT(i)+YOFFSET,CURRENT(2)+ZOFFSET)
            NEXT
            x1 = CENTRE.X+CURRENT(0)
            y1 = CENTRE.Y+CURRENT(1)
            x2 = CENTRE.X+CURRENT(3)
            y2 = CENTRE.Y+CURRENT(4)
            LINE(x1,y1)-(x2,y2)
        ENDIF
    NEXT
END SUB

Function FOV(COORD1,COORD2)
    DISTANCE = 240
    ANGLE = Deg(Atn(COORD1 / (DISTANCE + COORD2)))
    FOV = (Tan(Rad(ANGLE)) * DISTANCE)
End Function

Sub KEYPRESS
    KEYPRESS$ = InKey$
    If KEYPRESS$ <> "" Then
        If KEYPRESS$ = "q" Then
            ROTATE("ZMINUS")
            SENDLINES
        ElseIf KEYPRESS$ = "e" Then
            ROTATE("ZPLUS")
            SENDLINES
        ElseIf KEYPRESS$ = "w" Then
            ROTATE("XMINUS")
            SENDLINES
        ElseIf KEYPRESS$ = "s" Then
            ROTATE("XPLUS")
            SENDLINES
        ElseIf KEYPRESS$ = "a" Then
            ROTATE("YMINUS")
            SENDLINES
        ElseIf KEYPRESS$ = "CURRENT(2)" Then
            ROTATE("YPLUS")
            SENDLINES
        EndIf
    EndIf
End Sub

SUB DEMO
    DO
        KEYPRESS
    LOOP
END SUB